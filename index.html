<!DOCTYPE html>
<html>

<head>
    <title>Cooler Information</title>
    <style type="text/css">

        canvas {
            width: 100%;
            height: 35rem;

        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
</head>

<body>
    <h1 style="text-align: center;">

        Data
    </h1>
    <h3 align="left" vaglin="middle" style="margin-left: 2rem; margin-right: auto;">
        Cooler One
        <h4 style="margin-left: 0rem;">Temperature: <span id="cooler1Temp"></span></h4>
    </h3>

    <h3 align="left" vaglin="middle" style="margin-left: 2rem;">
        Cooler Two
        <h4 style="margin-left: 0rem;">Temperature: <span id="cooler2Temp"></span></h4>
    </h3>

    <h3 align="left" vaglin="middle" style="margin-left: 2rem; margin-right: auto;">
        Cooler 3
        <h4 style="margin-left: 0rem;">Temperature: <span id="cooler3Temp"></span></h4>
    </h3>

    <h3 align="left" vaglin="middle" style="margin-left: 2rem; margin-right: auto;">
        Freezer
        <h4 style="margin-left: 0rem;">Temperature: <span id="freezerTemp"></span></h4>
    </h3>

    <canvas id="chartContainer"></canvas>
    <script src = "CoolerSensor.js"> </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.js"></script>
    <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-base.min.js"></script>
    <script>
        var data;
        var sensorMap = new Map();
fetch('http://localhost:3000/temperature')
    .then((response) => response.json())
    .then((json) => {
        console.log(json); // Log the received data to the console

        data = json;
        Object.values(data).forEach(element => {
            var temp = Object.values(element);
          
            sensorMap.set(temp[0], new CoolerSensor(temp[1], temp[2], temp[3], temp[4] , temp[5]))
        })

        var cooler1Sensor = sensorMap.get("64a5957082a0dadb53cdebb6");
        var cooler2Sensor = sensorMap.get("64a5c6d33120c2441148a755");
        var cooler3Sensor = sensorMap.get("64a5c70a3120c2441148a757");
        var freezerSensor = sensorMap.get("64a5c7333120c2441148a759");

        var cooler1Temps = cooler1Sensor ? [cooler1Sensor.temp] : [];
        var cooler2Temps = cooler2Sensor ? [cooler2Sensor.temp] : [];
        var cooler3Temps = cooler3Sensor ? [cooler3Sensor.temp] : [];
        var freezerTemps = freezerSensor ? [freezerSensor.temp] : [];

        console.log(cooler1Temps); // Log the Cooler 1 temperature values to the console
        console.log(cooler2Temps); // Log the Cooler 2 temperature values to the console
        console.log(cooler3Temps); // Log the Cooler 3 temperature values to the console
        console.log(freezerTemps); // Log the Freezer temperature values to the console

        // Update the HTML elements with temperature values
        document.getElementById("cooler1Temp").innerText = cooler1Temps.join(", ") || "N/A";
        document.getElementById("cooler2Temp").innerText = cooler2Temps.join(", ") || "N/A";
        document.getElementById("cooler3Temp").innerText = cooler3Temps.join(", ") || "N/A";
        document.getElementById("freezerTemp").innerText = freezerTemps.join(", ") || "N/A";

        // Create a line chart using Chart.js
        var ctx = document.getElementById('chartContainer').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.map(cooler => cooler.time), // Assuming time represents the x-axis values
                datasets: [
                    {
                        label: 'Cooler 1',
                        data: cooler1Temps,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Cooler 2',
                        data: cooler2Temps,
                        backgroundColor: 'rgba(192, 75, 75, 0.2)',
                        borderColor: 'rgba(192, 75, 75, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Cooler 3',
                        data: cooler3Temps,
                        backgroundColor: 'rgba(192, 192, 75, 0.2)',
                        borderColor: 'rgba(192, 192, 75, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Freezer',
                        data: freezerTemps,
                        backgroundColor: 'rgba(75, 75, 192, 0.2)',
                        borderColor: 'rgba(75, 75, 192, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'Temperature (°C)'
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Cooler Temperatures',
                        font: {
                            size: 20
                        }
                    }
                }
            }
        });
   

    })
    .catch((error) => {
        console.error('Error fetching data:', error);
    });




            
            

        Cooler Temperatures
    </h1>

    <div class="cooler-info">
        <!-- Generate cooler information elements dynamically -->
    </div>


    <canvas id="chartContainer"></canvas>
    <script src="CoolerSensor.js"> </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.1/dist/chart.js"></script>
    <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-base.min.js"></script>
    <script>
        var data = [];
        var sensorMap = new Map();
        var coolerTemps = new Map();

        var colorMap = new Map();

        fetchTemperatureData();

        function fetchTemperatureData() {
            fetch('http://localhost:3000/temperature')
                .then(response => response.json())
                .then(json => {
                    console.log(json); // Log the received data to the console

                    data = json; // Store the data in the data variable

                    updateSensorMap(json); // Update the sensor map with the merged data

                    updateColorMap();

                    console.log(coolerTemps); // Print the temperature values from

                    // updateTemperatureArrays();

                    logTemperatureValues();

                    updateHTMLElements();

                    createLineChart();
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                });
        }

        function updateSensorMap(json) {
            Object.values(json).forEach(element => {
                var sensorId = element.coolerNumber;
                var coolerSensor = new CoolerSensor(
                    element.coolerNumber,
                    element.temperature,
                    element.doorOpen,
                    element.doorTimeOpen,
                    element.previousTemperatures,
                    element.time
                );
                console.log(coolerSensor.time);

                coolerTemps.set(sensorId, element.previousTemperatures);
                sensorMap.set(sensorId, coolerSensor);
            });
        }




        function updateColorMap() {
            colorMap.set("001", 0x0ad0fd);
            colorMap.set("011", 0x0f00fd);
            colorMap.set("021", 0x0cf0fd);
            colorMap.set("030", 0x02f0fd);
        }


        // function updateTemperatureArrays() {
        //     sensorMap.forEach((coolerSensor, sensorId) => {
        //         var temperatureArray = coolerTemps[sensorId];
        //         temperatureArray.push(coolerSensor ? coolerSensor.temp : null);
        //     });
        // }

        function logTemperatureValues() {
            Object.entries(coolerTemps).forEach(([sensorId, temperatureArray]) => {
                console.log(`${sensorId} Temperatures:`, temperatureArray.join(", "));
            });
        }

        function updateHTMLElements() {
            var coolerInfoElement = document.querySelector('.cooler-info');
            coolerInfoElement.innerHTML = '';
            sensorMap.forEach((coolerSensor, sensorId) => {
                var coolerNumber = coolerSensor.id;
                var coolerDiv = document.createElement('div');
                var tempNum = coolerSensor.temp;
                coolerDiv.innerHTML = `
                    <h3>${(coolerNumber % 10 == 0 ? "Freezer " : "Cooler ") + [coolerNumber[0] + coolerNumber[1]]} </h3>
                    <h4>Latest Temperature: ${tempNum}℃</h4>
                `;
                coolerInfoElement.appendChild(coolerDiv);
            });
        }

        function convertToReadableTime(time) {
            const hours = ((time / 3600000) % 24);
            return hours > 12 ? Math.round(hours) - 12 : Math.round(hours);
        }

        function createLineChart() {
            var ctx = document.getElementById('chartContainer').getContext('2d');
            // console.log(convertToReadableTime(sensorMap[0].time));
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.map(cooler => convertToReadableTime(cooler.time) ),
                    datasets: Array.from(coolerTemps.entries()).map(([sensorId, temperatureArray], index) => ({
                        label: `Cooler ${index + 1}`,
                        data: temperatureArray,
                        backgroundColor: `#${colorMap.get(sensorId).toString(16)}`,
                        borderWidth: 1
                    }))
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Temperature (°C)'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Cooler Temperatures',
                            font: {
                                size: 20
                            }
                        }
                    }
                }
            });
        }


        function getRandomRGBValue() {
            return Math.floor(Math.random() * 256);
        }

    </script>
</body>

</html>